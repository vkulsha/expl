<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="Cache-Control" content="no-cache" />
		
		<link rel="shortcut icon" href="/images/logo.png" type="image/png">
		<link rel="stylesheet" href="css/leaflet.css" />
		<link rel="stylesheet" type="text/css" href="css/main.css">

		<script src="js/jquery-2.2.0.min.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/leaflet.js"></script>		
		<script src="js/uService.js"></script>
		<script src="js/Main.js"></script>
		<script src="js/objectlink.js"></script>
		<script src="js/jscharts.js"></script>

<script>
////////////policy
	var classes_ = objectlink.gOrm("gT2",[["Класс"],[],[0],false,["Класс","id_Класс"]]);
	var classes = hash4arr(classes_);
			
////////////documentReady
	$(document).ready(function(){
		var oids = [];
		console.log("classes count: "+classes_.length);

		var pLogin = gDom("pLogin");
		pLogin.style.left = Math.round(windowWidth()/2) - 100 + "px";
		pLogin.style.top = Math.round(windowHeight()/2) - 50 + "px";

		var bLogin = gDom("bLogin");
		
		bLogin.onclick = function(){
			var auth = false;
			var eUser = $("#eUser").val();
			var password = document.fLogin.ePassword.value;

			var openview = function() {
				gDom("mainContainer").hidden = true;
				gDom("pMain").hidden = false;
				gDom("addressSearch").focus();
			}
			
			var getLDAP = function() {
				getHttp("ldap.php?p1="+eUser+"&p2="+password+"&p3=guss.ru", function(responce) {
					var resp = JSON.parse(responce);
					if (resp) {
						openview();
					} else {
					}
				}, false);
			}
			
			var u = objectlink.gOrm("gAnd",[[classes["Пользователи"]],"id",false,"and n='"+eUser+"'"]);
			var p = objectlink.gOrm("gAnd",[[classes["Пароли пользователей"]],"id",false,"and n='"+password+"'"]);
			if (u && p && u.length && p.length){
				var key = objectlink.gOrm("gAnd", [[u[0][0], p[0][0], classes["Ключи доступа пользователей"]]]);
				if (key && key.length){
					openview();
				} else if (u && u.length) {
					getLDAP();
				}
			} else if (u && u.length){
				getLDAP();
			}
			currentUser.oid = u && u.length && u[0][0] ? u[0][0] : 1;
		}
		
		var pMain = gDom("pMain");
		pMain.style.height = windowHeight()-170+"px";
		var pObjects = gDom("pObjects");
		var pObject = gDom("pObject");

		var pDop =  gDom("pDop");
		pDop.style.left = windowWidth()-parseInt(pDop.style.width)-5+"px";
		pDop.style.top = windowHeight()-parseInt(pDop.style.height)-5+"px";
		var pDopData = gDom("pDopData");

		var setup = gDom("setup");
		var eDopWidth = gDom("eDopWidth");
		var eDopHeight = gDom("eDopHeight");
		eDopWidth.onchange = function(){
			pDop.style.width = this.value;
			pDop.style.left = windowWidth()-parseInt(pDop.style.width)-5+"px";
		};
		eDopHeight.onchange = function(){
			pDop.style.height = this.value;
			pDop.style.top = windowHeight()-parseInt(pDop.style.height)-5+"px";
		};
		var logo = gDom("logo");
		logo.style.left = windowWidth()-parseInt(logo.style.width)-5+"px";
		logo.onclick = function(){
			eDopWidth.value=pDop.style.width;
			eDopHeight.value=pDop.style.height;
			showModalHtml(setup, true);
		}
		
////////////////modal
		var modal = document.getElementById('myModal');
		var span = document.getElementsByClassName("close")[0];

		span.onclick = function() {
			modal.style.display = "none";
		}

		window.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}
		
		window.onkeydown = function(event) {
			if (event.keyCode == 27) {
				modal.style.display = "none";
				
			} else 
			if (event.keyCode == 119) {
				if (isPaintMode) deleteLastPaintedPolygon(lastPaintedPolyline);
			}
		};

////////////////showModal
		function showModal(uri, _oid, mainoid) {
			gDom("modalTitle").innerHTML = "";
			gDom("modalBody").innerHTML = "";
			gDom("modalFooter").innerHTML = "";
			
			if (_oid) location.href = mainHtmlPage+"#oid="+mainoid+"&"+objectIdUrlKey+"="+_oid;
			modal.style.display = "block";
			getHttp(uri, function(data){ $("#modalBody").append(data); }, true);
			//loadXML(uri, true, true, false, function(data){
			//	$("#modalBody").append(data);
			//});
		
		}

		function showModalHtml(html, clear) {
			if (clear){
				gDom("modalTitle").innerHTML = "";
				gDom("modalBody").innerHTML = "";
				gDom("modalFooter").innerHTML = "";
			}
			$("#modalBody").append(html);
			modal.style.display = "block";
			
		}

		function showInf(container, html) {
			container.innerHTML = "";
			$(container).append(html);
			container.parentNode.hidden = false;				
		}
		
////////////////map init
		var map = L.map('map');
		var mapObjects = initMap(map);
///paint editor
		var paintArr = [];
		var paintMarkers = L.layerGroup();
		var lastPaintMarkers = L.layerGroup();
		var isPaintMode = false;
		var isEditMode = false;
		var lastPaintedPolyline = 0;
		var zdzuPolygonsLayer = L.layerGroup();
		var commPolygonsLayer = L.layerGroup();
		var arendPolygonsLayer = L.layerGroup();

		var chPaintMode = gDom("chPaintMode");
		chPaintMode.checked = isPaintMode;
		chPaintMode.onclick = function() {
			isPaintMode = this.checked;
		}
		
		var chEditMode = gDom("chEditMode");
		chEditMode.checked = isEditMode;
		chEditMode.onclick = function() {
			isEditMode = this.checked;
		}

		map.on('click', function(e) {
			console.log(e.latlng.lat, e.latlng.lng)
			if (isPaintMode) {
				paintArr.push([e.latlng.lat, e.latlng.lng]);
			}
		});
		map.on('mousemove', function(e) {
			if (isPaintMode && paintArr && paintArr.length) {
				var arr = paintArr.slice();
				arr.push([e.latlng.lat, e.latlng.lng]);
				paintMarkers.clearLayers();
				L.polyline(arr, {color:"#ff0000", weight:1}).addTo(paintMarkers);
				map.removeLayer(paintMarkers);
				paintMarkers.addTo(map);
			}
		});
		map.on('contextmenu', function(e) {
			if (isPaintMode && paintArr.length) {
				var n = objectlink.gOrm("gN",[currentCommOid]);
				var oid = prompt(n || "", currentCommOid);
				if (oid && oid != 0) {
					lastPaintedPolyline = createPolylineFromArr(paintArr, oid);
					lastPaintMarkers = paintMarkers;
					console.log("save polygon oid:"+oid+", arraylength: "+paintArr.length+", polyId: "+lastPaintedPolyline);
					window.alert("сохранена линия № "+lastPaintedPolyline);
				} else {
				    console.log("oid: "+oid);
					map.removeLayer(paintMarkers);
				}
				paintArr = [];
				paintMarkers = L.layerGroup();
			}
		});
		
		function deleteLastPaintedPolygon(oid){
			var oid = prompt("Удалить последнюю линию №", oid);
			if (oid) {
				objectlink.gOrm("eO",[oid, null]);
				map.removeLayer(lastPaintMarkers);
			}
		}
		
		function createPolylineFromArr(arr, oid) {
			return createPolygonObject(arr, oid, "полигон на карте объекта " + oid + " " + d2str(new Date()));
		}
		
		function createCardUploadFiles(dom, oid) {
			getHttp("cardUploadFiles.htm", function(data){ 
				$(dom).append(data);
				gDom("selectFileUploadPath").setAttribute("value", "data/"+oid+"/");
				gDom("selectFileUploadId").setAttribute("value", oid);

				var arrChFileButtonHtml = document.getElementsByClassName("chFileButtonHtml");
				for (var i=0; i < arrChFileButtonHtml.length; i++) {
					arrChFileButtonHtml[i].hidden = false;
				}

				var butDelete = cInp("BUTTON", null, pDopData);
				butDelete.value = "Удалить выделенные файлы";
				butDelete.arrChbxs = arrChFileButtonHtml;

				butDelete.onclick = function(){
					var arr = [];
					var oids = [];
					for (var i=0; i < this.arrChbxs.length; i++) {
						if (this.arrChbxs[i].checked) {
							arr.push(this.arrChbxs[i].value);
							oids.push(this.arrChbxs[i].id.slice(3));
						};
					}
					
					if (prompt("Удалить файлы ("+arr.length+" шт.)?", "Да") == "Да") {
						$.post('delete.php', {deletePath: "data/"+oid+"/", file: arr})
						.done(function( data ) {
							if (data && data.length) {
								for (var i=0; i < data.length; i++) {
									if (data[i].status == "fail") {
										alert("Ошибка удаления файла: "+data[i].name);
										for (var j=0; j < arr.length; j++) {
											if (arr[j].indexOf(data[i].name)+1) {
												oids.splice(j,1);
											}
										}
									}
								}
							}
							for (var i=0; i < oids.length; i++) {
								objectlink.gOrm("eO",[oids[i], null]);
							}
							console.log("delete files and eO:");
							console.log(oids);
						});
					}
					
				};
				cDom("BR",undefined,pDopData); cDom("BR",undefined,pDopData);

			}, true);
		}

		var arrComm = [[], [], [], []];
		var arrLines = [[], [], [], []];
		var arendatorMarker0, arendatorMarker2, arendatorMarker3, arendatorMarker4, arendatorMarker5, arendatorMarker6, arendatorMarker7, arendatorMarker8, arendatorMarker9;
		var arendatorMarkers = [];
		var polylines = [];
		var currentCommOid = 0;

		window.onhashchange = function(){
			hashchange(mapObjects, arrComm, arrLines);
		}

	 	loadMainListOfObjects();
		polylines = loadAndPaintAllPolygons(zdzuPolygonsLayer);
		zdzuPolygonsLayer.addTo(map);
		var oid = $_GET("oid", "#", location.hash);
		if (oid) {
			hashchange(mapObjects, arrComm, arrLines)
		}

		function setCommVisible(commNum, visible){
			if (commNum == undefined || commNum > arrComm.length-1) return;
			for (var i=0; i < arrComm[commNum].length; i++) {
				arrComm[commNum][i].setOpacity(visible ? 1 : 0);
			}
			for (var i=0; i < arrLines[commNum].length; i++) {
				arrLines[commNum][i].setStyle({opacity: visible ? 1 : 0});
			}
		}
		function setCommsVisible(visible){
			for (var i=0; i < arrComm.length; i++) {
				setCommVisible(i, visible);
			}
			//for (var i=0; i < arendatorMarkers.length; i++){
			//	arendatorMarkers[i].setOpacity(visible ? 1 : 0);
			//}
			arendPolygonsLayer.clearLayers();
		}
		function getPolylineByOid(oid_, polylines_){
			if (polylines_) {
				for (var i=0; i < polylines_.length; i++){
					if (oid_ == polylines_[i].oid) {
						return polylines_[i];
					}
				}
			}
		}
		function setPolylineColor(polyline, color){
			if (polyline) polyline.setStyle({"color" : color});
		}

////////////////polygons communications
////////////////markers electro
//console.time();
		var el = objectlink.gOrm("gT2",[["Электроснабжение", "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Электроснабжение`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
//console.timeEnd();
		var elLines = mapPaint(el, L.polyline, {color:"#ff9900", weight:2}, commPolygonsLayer, classes["Электроснабжение"]);
		if (elLines && elLines.length){
			var elCoord = elLines[0].getLatLngs()[0];
			var markerElectro = markerAddToMap(commPolygonsLayer, [elCoord.lat, elCoord.lng], "images/markerElectro.png")
			arrComm[0] = [markerElectro];
			arrLines[0] = elLines;
			setCommVisible(0, false);
		}

////////////////markers teplo
//console.time();
		var te = objectlink.gOrm("gT2",[["Отопление", "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Отопление`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
//console.timeEnd();
		var teLines = mapPaint(te, L.polyline, {color:"#ffff00", weight:3}, commPolygonsLayer, classes["Отопление"]);
		if (teLines && teLines.length){
			var teCoord = teLines[0].getLatLngs()[0];
			var markerTeplo = markerAddToMap(commPolygonsLayer, [teCoord.lat+0.00005, teCoord.lng], "images/moek.png")
			arrComm[1] = [markerTeplo];
			arrLines[1] = teLines;
			setCommVisible(1, false);
		}

////////////////markers water
//console.time();
		var wa = objectlink.gOrm("gT2",[["ХВС", "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_ХВС`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
//console.timeEnd();
		var waLines = mapPaint(wa, L.polyline, {color:"#0000ff", weight:3}, commPolygonsLayer, classes["ХВС"]);
		if (waLines && waLines.length){
			var waCoord = waLines[0].getLatLngs()[0];
			var markerWater = markerAddToMap(commPolygonsLayer, [waCoord.lat, waCoord.lng], "images/markerWater.png")
			arrComm[2] = [markerWater];
			arrLines[2] = waLines;
			setCommVisible(2, false);
		}

////////////////markers kanalization
//console.time();
		var ka = objectlink.gOrm("gT2",[["Канализация", "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Канализация`"], " and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
//console.timeEnd();
		var kaLines = mapPaint(ka, L.polyline, {color:"#ff9900", weight:3}, commPolygonsLayer, classes["Канализация"]);
		if (kaLines && kaLines.length){
			var kaCoord = kaLines[0].getLatLngs()[kaLines[0].getLatLngs().length-1];
			var markerKanal = markerAddToMap(commPolygonsLayer, [kaCoord.lat, kaCoord.lng], "images/markerKanal.png")
			arrComm[3] = [markerKanal];
			arrLines[3] = kaLines;
			setCommVisible(3, false);
		}
		/*///paint communications icons
		var mar = objectlink.gOrm("gT2",[["Здания и сооружения", "Электроснабжение","Отопление","ХВС","Канализация","Объект"],[],[],false, 
			["id_Электроснабжение","id_Отопление","id_ХВС","id_Канализация", "`id_Здания и сооружения`","id_Объект"]]);
		for (var i=0; i < polylines.length; i++){
////////////////////paint communications
			var points = [];
			for (var j=0; j < polylines[i].getLatLngs()[0].length; j++){
				var lat = polylines[i].getLatLngs()[0][j].lat;
				var lng = polylines[i].getLatLngs()[0][j].lng;
				points.push([lat, lng]);
			}
			var center = getCenterFromPoints(points);
			var _oid = polylines[i].oid;
			
			var arrMar = ["Электроснабжение","Отопление","ХВС","Канализация"];
			var arrMarIcons = ["images/markerElectro.png","images/moek.png","images/markerWater.png","images/markerKanal.png"];
			for (var k=0; k<4; k++) {
				for (var m=0; m < mar.length; m++) {
					if (mar && mar.length && mar[m].length && mar[m][4] == _oid && mar[m][k] && mar[m][k] != _oid) {
						var markerMap = markerAddToMap(commPolygonsLayer, [center[0], center[1]], arrMarIcons[k])
						arrComm[k].push(markerMap);
					}
				}
			}
			setCommsVisible(false);
		}*/
		commPolygonsLayer.addTo(map);
/////////////////////////////					
	
		function hashchange(mapObjects_, arrComm_, arrLines_){
			var oid_ = oid;
			oid = $_GET("oid", "#", location.hash);// || "115";
			
			if (!oid) return;
			pObject.style.display = "table";
			pObjects.style.display = "none";
			var ind = mapObjects_.objects.oid.indexOf(oid);
			if (~ind) map.setView([mapObjects_.objects.lat[ind], mapObjects_.objects.lon[ind]], mapObjects_.objects.zoom[ind] || 18);
			
			pObject.innerHTML = "";
			pDop.hidden = false;
////////////about object			
//console.time();
			var zd = objectlink.gOrm("gT2",[["Объект","Здания и сооружения","Адрес","ИК","Ответственный","ТУ"],[[3,0],[4,3],[5,3]]/*,[3,5]*/,[],false,null, "and `id_Объект` = "+oid+" order by `id_Здания и сооружения`"]);
			var zu = objectlink.gOrm("gT2",[["Объект","Земельные участки"],[]/*,[]*/,[],false,null, "and `id_Объект` = "+oid+" order by `id_Земельные участки`"]);
//console.timeEnd();
			$(pObject).append("Объект: <label style='color:#00ff00'>"+zd[0][1]+"</label><br>");
			$(pObject).append("Адрес: <label style='color:#00ff00'>"+zd[0][5]+"</label><br>");
			$(pObject).append("Территориальное управление: <label style='color:#00ff00'>"+zd[0][11]+"</label><br>");
			$(pObject).append("Имущественный комплекс: <label style='color:#00ff00'>"+zd[0][7]+" ("+zd[0][9]+") </label><br>");
////////////object communications
			var getCommVisible;
			var comms = ["Электроснабжение","Отопление","ХВС","Канализация","Интернет","Вывоз КГМ и ТБО","Охрана"];
//console.time();
			var getCommOnObject = objectlink.gOrm("gT2",[["Объект"].concat(comms),[]/*,[]*/,[],false,decorateArr(comms, "`id_", "`")/*.join(",")*/," and `id_Объект`="+oid+" order by "+decorateArr(comms, "`id_", "` desc ").join(",")+" limit 1"]);
//console.timeEnd();
			//console.log(objectlink.gOrm("gTq2",[["Объект"].concat(comms),[],[],false,decorateArr(comms, "`id_", "`")," and `id_Объект`="+oid]));
			//console.log(getCommOnObject[0]);
			var electroId = getCommOnObject[0][0];
			var teploId = getCommOnObject[0][1];
			var waterId = getCommOnObject[0][2];
			var kanalId = getCommOnObject[0][3];
			var internetId = getCommOnObject[0][4];
			var musorId = getCommOnObject[0][5];
			var securityId = getCommOnObject[0][6];
			arrParamsComm = [
				["Электроснабжение", "Договоры"/*, "Счетчики", "Потребляемая мощность", "Расходы по счетчикам за год", "Потребление за год"*/, "Файлы", "Объект"],
				["Отопление", "Договоры"/*, "Счетчики", "Потребляемая мощность", "Расходы по счетчикам за год", "Потребление за год"*/, "Файлы", "Объект"],
				["ХВС", "Договоры"/*, "Счетчики", "Потребляемая мощность", "Расходы по счетчикам за год", "Потребление за год"*/, "Файлы", "Объект"],
				["Канализация", "Договоры"/*, "Счетчики", "Потребляемая мощность", "Расходы по счетчикам за год", "Потребление за год"*/, "Файлы", "Объект"],
				["Интернет", "Договоры", "Файлы", "Объект"],
				["Вывоз КГМ и ТБО", "Договоры", "Файлы", "Объект"],
				["Охрана", "Договоры", "Вид охраны", "Количество постов", "Количество человек", "ФИО", "Файлы", "Объект"],
				["Работники", "Инф о работнике", "Файлы", "Объект"],
				[],
			]
			$(pObject).append("<br>Основные коммуникации на объекте:<br>");
			var el = [
				[0,"Электроснабжение","images/electro2.png", [arrParamsComm[0]]],
				[1,"Теплоснабжение","images/batery2.png", [arrParamsComm[1]]],
				[2,"Водоснабжение","images/coldwater2.png", [arrParamsComm[2]]],
				[3,"Водоотведение","images/unitaz2.png", [arrParamsComm[3]]],
			];
			var fclick = function(){
				pDopData.innerHTML = "";

				for (var i=0; i < this.params.length; i++){
					fillCard2(this.params[i], oid, pDopData);
				}
				pDop.hidden = false;
				setCommsVisible(false);
				getCommVisible = this.ind;
				setCommVisible(getCommVisible, true);
				currentCommOid = this.ind > -1 && this.ind < 4 ? getCommOnObject[0][this.ind] : 0;
				
				if (isEditMode) {
					createCardUploadFiles(pDopData, currentCommOid);
				}

				if (isPaintMode) {
					var el = ["Электроснабжение","Отопление","ХВС","Канализация"];
					if (!currentCommOid) {
						currentCommOid = objectlink.gOrm("cO", [el[this.ind]+" "+oid+" "+d2str(new Date()), classes[el[this.ind]]]);
						objectlink.gOrm("cL", [currentCommOid, oid]);
						getCommOnObject[0][this.ind] = currentCommOid;
					}
				}
				
				if (this.ind < 3) {
					var commT = ["expl_comm_el","expl_comm_tp","expl_comm_wa","expl_comm_ka"];
					var thArr = ["Марка №","Дата изготовления/ввода","Межпроверочный интервал","Дата след проверки","Примечание","Примечание2"];
					var arr = getOrm("select * from "+commT[this.ind]+" where f2 is not null and f2 <> '' and f2 = "+oid, "all2object").data;
					var tb = pDopData.appendChild(cDom("TABLE"));
					for (var i=0; i < arr.length; i++) {
						var tr = tb.appendChild(cDom("TR"));
						var tdh = tr.appendChild(cDom("TD"));
						var tdv = tr.appendChild(cDom("TD"));
						tdh.innerHTML = "Прибор учета №"+(i+1);
						tdh.style.color = "#ccc";
						tdh.style.fontWeight = "bold";

						for (var j=0; j <=5; j++) {
							var tr = tb.appendChild(cDom("TR"));
							var tdh = tr.appendChild(cDom("TD"));
							tdh.innerHTML = thArr[j];
							tdh.style.borderBottom = "1px solid #333";
							tdh.style.color = "#999";

							var tdv = tr.appendChild(cDom("TD"));
							var val = arr[i][j+5];
							tdv.innerHTML = val;
							tdv.style.borderBottom = "1px solid #333";
						}
						var tr = tb.appendChild(cDom("TR"));
						var tdh = tr.appendChild(cDom("TD"));
						var tdv = tr.appendChild(cDom("TD"));
						tdh.innerHTML = "<BR>";
					}
				}
				
			}
			loadPanel(el, pObject, 0, 1, fclick, null, null, 2, true, 3);
////////////other object information
			$(pObject).append("Дополнительно (договоры, арендаторы, отчеты):<br>");
			/*var el = [
				[0,"Интернет","images/vols2.png", [arrParamsComm[4]]],
				[1,"Вывоз КГМ и ТБО","images/tbo.png", [arrParamsComm[5]]],
				[2,"Охрана","images/security2.png", [arrParamsComm[6]]],
				[3,"Арендаторы","images/money.png", getArendatorInf],
				[4,"Отчеты","images/report.png", getReportsInf],
			];*/
			var el = [
				[0,"Договоры на обслуживание","images/tbo.png", getOtherDog],
				[1,"Арендаторы","images/money.png", getArendatorInf],
				[2,"Отчеты","images/report.png", getReportsInf],
			];
			var fclick = function(){
				pDopData.innerHTML = "";
				if (typeof(this.params) == "object") {
					for (var i=0; i < this.params.length; i++){
						fillCard2(this.params[i], oid, pDopData);
						//if (this.params[i][0] == "Работники") {
						//	console.log(123);
						//}
					}
				} else {
					this.params(polylines, oid);
				}
				pDop.hidden = false;				
				setCommsVisible(false);
				getCommVisible = undefined;

				if (isEditMode && this.ind<3) {
					currentCommOid = this.ind > -1 && this.ind < 4 ? getCommOnObject[0][this.ind] : 0;
					var el = ["Интернет","Вывоз КГМ и ТБО","Охрана"];
					if (!currentCommOid) {
						currentCommOid = objectlink.gOrm("cO", [el[this.ind]+" "+oid+" "+d2str(new Date()), classes[el[this.ind]]]);
						objectlink.gOrm("cL", [currentCommOid, oid]);
					}
					
					createCardUploadFiles(pDopData, currentCommOid);
					console.log(currentCommOid);
				}
			}
			loadPanel(el, pObject, 0, 1, fclick, null, null, 2, true, 3);
			
////////////include territorias
			$(pObject).append("<br>Земельный участок:<br>");
			var fclick = function(){
				if (isPaintMode) return;
				pDopData.innerHTML = "";
				$(pDopData).append("<h3>"+this.innerHTML+"</h3>");
				fillCard2(["Правоустанавливающие документы", /*"Объект права", "Адрес", "Субъект права", "Вид права", "Документы-основания", "Кадастровый номер", "Обременения", "Номер записи регистрации в ЕГРП", "Дата документа",*/ "Файлы","Земельные участки"], this.oid, pDopData);
				fillCard2(["Кадастровый паспорт", "Общая площадь", "Кадастровый номер", /*"Категория земель", "Разрешенное использование", "Кадастровая стоимость", "Обременения", "Лица в отношении которых применены обременения", "Дата постановки на ГКУ",*/ "Файлы", "Земельные участки"], this.oid, pDopData);
				pDop.hidden = false;
				setCommsVisible(false);
				getCommVisible = undefined;
			}
			function fover(){
				this.style.backgroundColor = "rgba(0,255,0,0.3)";
				setPolylineColor(getPolylineByOid(this.oid, this.polylines), "#ff5555");
			}
			function fout(){
				this.style.backgroundColor = "rgba(0,0,0,0.3)";
				setPolylineColor(getPolylineByOid(this.oid, this.polylines), "#00ff00");
			}
			
			loadPanel(zu, pObject, 2, 3, fclick, fover, fout);
////////////include object properties
			$(pObject).append("<br>Состав имущества на объекте ("+zd.length+"):<br>");
			var fclick = function(){
				console.log("zd oid: "+this.oid);
				if (isPaintMode) return;
				pDopData.innerHTML = "";
				$(pDopData).append("<h3>"+this.innerHTML+"</h3>");
//console.time();
				var photo = objectlink.gOrm("gT2",[["Здания и сооружения", "Фото"],[]/*,[]*/,[],false, ["`Фото`"], "and `id_Здания и сооружения` = "+this.oid+" order by `id_Фото`"]);
//console.timeEnd();
				if (photo && photo.length) {
					if (photo[0][0]) {
						$(pDopData).append("<button id='bImg'><img src="+photo[0][0]+" width='64'/></button>")
						var bImg = gDom("bImg");
						bImg.oid = this.oid
						bImg.style.backgroundColor = "rgba(0,0,0,0)";
						bImg.style.border = "0px";
						bImg.style.cursor = "pointer";
						bImg.onclick = function(){
							cardPhotoOid = this.oid;
							//showModal("cardPhoto.htm", this.oid, oid);
							showModal("cardPhoto.htm");
							
						}
					}
				}
				
				if (isEditMode) {
					var arr = objectlink.gOrm("gT2",[["Объект", "Электроснабжение", "Отопление", "ХВС", "Канализация"],[],[],false,null,"and `id_Объект` = "+oid]);
					for (var i=1; i<=4; i++) {
						var br = cDom("BR", null, pDopData);
						var ch = cInp("CHECKBOX", null, pDopData);
						var la = cDom("LABEL", null, pDopData);
						ch.setAttribute("id", "chEdit"+arr[0][i*2]);
						la.setAttribute("for", "chEdit"+arr[0][i*2]);
						la.innerHTML = arr[0][i*2+1];
						ch.oid = arr[0][i*2];
						ch.zd = this.oid;
						ch.checked = objectlink.gOrm("gL", [ch.zd, ch.oid]);
						ch.onclick = function(){
							if (this.checked) {
								objectlink.gOrm("cL", [this.zd, this.oid]);
								//console.log("cL " + this.zd + "," + this.oid);
							} else {
								objectlink.gOrm("eL", [this.zd, this.oid]);
								//console.log("eL " + this.zd + "," + this.oid);
							}
						}
					}
				}
				
				//fillCard2(["Коммуникации на объекте", "Электроснабжение","Отопление","ХВС","Канализация","Интернет","Вывоз КГМ и ТБО","Охрана", "Здания и сооружения"], this.oid, pDopData)
				fillCard2(["Правоустанавливающие документы", /*"Объект права", "Адрес", "Субъект права", "Вид права", "Документы-основания", "Кадастровый номер", "Обременения", "Номер записи регистрации в ЕГРП", "Дата документа",*/ "Файлы", "Здания и сооружения"], this.oid, pDopData);
				fillCard2(["Технические данные", "Общая площадь", /*"Полезная площадь", "Площадь застройки",*/ "Число этажей", /*"Высота этажа", "Коммуникации в здании", "Стены", "Перегородки", "Перекрытия", "Фундамент",*/ "Год постройки", /*"Состояние", "Процент износа", "Литера", "Инвентарный номер", "Дата документа",*/ "Файлы", "Здания и сооружения"], this.oid, pDopData);
				fillCard2(["Файлы", "Здания и сооружения"], this.oid, pDopData);
				//fillCard2(["Материально ответственное лицо", "ФИО", "Телефон", "Email", "Файлы", "Здания и сооружения"], this.oid, pDopData);
				pDop.hidden = false;
				setCommsVisible(false);
				getCommVisible = undefined;
			}
			loadPanel(zd, pObject, 2, 3, fclick, fover, fout, undefined, undefined, undefined, polylines);
			
			//if (oid && oid != 115){
			if (true){
				pDopData.innerHTML = "";
				$(pDopData).append("<h3>Общая информация</h3>");

//console.time();
				var objectId = objectlink.gOrm("gT2",[["Номер","Объект"],[],[],false,null,"and `id_Объект` ="+oid+" limit 1"]);
//console.timeEnd();
				if (objectId && objectId.length) {
					objectId = objectId[0][1];
					var objectPath = getObjectsDir()+"/"+objectId+"/";
					var imageFiles = [];
					var otherFiles = [];
					getHttp("scanDir.php?path="+objectPath, function(imagesJSON) {
						var files = JSON.parse(imagesJSON);
						var allFiles = splitObjectArray(files, {"images" : ["jpg", "png", "gif", "tif", "bmp"], "other" : []} );
						imageFiles = allFiles.images.sort();
						otherFiles = allFiles.other.sort();
					}, false);

					if (imageFiles && imageFiles.length) {
						$(pDopData).append("<button style='border: 0px; cursor:pointer' id='bImg'><img src='"+domain+objectPath+url2cp1251(imageFiles[0])+"' width='64'/></button>")
						bImg = gDom("bImg");
						bImg.onclick = function(){
							showModal("cardPhotoObject.htm", oid, oid);
						}
					}
					
					if (isEditMode && otherFiles.length) {
						$(pDopData).append("<p>Файлы:</p>");
						var divVal = pDopData.appendChild(cDom("DIV"));
						for (var i=0; i < otherFiles.length; i++) {
							//if (otherFiles[i].indexOf("passport") > -1 && !isEditMode) continue;
							var fileButton = getFileButtonHtml(objectPath+url2cp1251(otherFiles[i]));
							$(divVal).append(fileButton);
						}
					}
				}
				
				pDop.hidden = false;
				setCommsVisible(false);
				getCommVisible = undefined;
			} else {
				pDopData.innerHTML = "";
			}
			
/////////////arendator
			arendatorMarker0 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker2 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker3 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker4 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker5 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker6 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker7 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker8 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendatorMarker9 = markerAddToMap(arendPolygonsLayer, [0, 0], "images/arendator.png", 64);
			arendPolygonsLayer.addTo(map);
			arendatorMarkers = [arendatorMarker0, arendatorMarker2, arendatorMarker3, arendatorMarker4, arendatorMarker5, arendatorMarker6, arendatorMarker7, arendatorMarker8, arendatorMarker9];
			
			function getArendatorInf(polylines, oid){
				var tb = cDom("TABLE");
				tb.style.width = "100%";
				var tr = tb.appendChild(cDom("TR"));
				var td = tr.appendChild(cDom("TD"));
				td.innerHTML = "Арендаторы";
				//var td = tr.appendChild(cDom("TD"));
				//td.innerHTML = "Договор";
				//var td = tr.appendChild(cDom("TD"));
				//td.innerHTML = "Площадь";

				console.log("Ожидайте");
				var arendators = objectlink.gOrm("gT2", [
					["Объект", "Арендаторы"/*, "Договоры аренды", "Участок аренды", "Занимаемая площадь"*//*, "Здания и сооружения", "Земельные участки"*/],
					[/*[2,1],[3,2],[4,3],[5,3],[6,3]*/],[],false,
					["`id_Арендаторы`", "`Арендаторы`"/*, "`Договоры аренды`", "`Занимаемая площадь`"*//*, "`id_Здания и сооружения`", "`id_Земельные участки`"*/],
					"and `id_Объект` = "+oid+" order by `id_Арендаторы`"
					]);
				console.log("Завершено");
				var idOld = 0;
				for (var i=0; i < arendators.length; i++){
					var id = arendators[i][0];
					var arendator = arendators[i][1];
					//var dog = arendators[i][2] ? arendators[i][2].split(",").join("<br>") : "";
					//var square = arendators[i][3] ? arendators[i][3].split(",").join("<br>") : "";
					var tr = tb.appendChild(cDom("TR"));
					var td = tr.appendChild(cDom("TD"));
					var but = td.appendChild(cDom("BUTTON"));
					but.innerHTML = arendator;
					but.id = "but"+id;
					but.oid = id;	
					but.style.width = "100%";
					but.polylines = polylines;
					
					//var td = tr.appendChild(cDom("TD"));
					//td.innerHTML = dog;
					//var td = tr.appendChild(cDom("TD"));
					//td.innerHTML = square;
					but.onclick = funcclick;
				}
				
				function funcclick(){
					var zdZu = objectlink.gOrm("gT2", [
					["Арендаторы", "Договоры аренды", "Участок аренды", "Здания и сооружения", "Земельные участки"],
					[[2,1],[3,2],[4,2]],[],false,
					["`id_Здания и сооружения`", "`id_Земельные участки`"],
					"and `id_Арендаторы` = "+this.oid
					]);
					var arr = [];
					for (var i=0; i < zdZu.length; i++){
						if (zdZu[i][0]) arr.push(zdZu[i][0]);
						if (zdZu[i][1]) arr.push(zdZu[i][1]);
					}
					arr = arr.filter(function onlyUnique(value, index, self) {return self.indexOf(value) === index;});
				
					var polylines = this.polylines;
					//for (var i=0; i < arendatorMarkers.length; i++){
					//	arendatorMarkers[i].setOpacity(0);
					//}
					arendPolygonsLayer.clearLayers();
					for (var m=0; m < arr.length; m++){
						for (var i=0; i < polylines.length; i++){
							var points = [];
							if (polylines[i].oid == arr[m]){
								for (var j=0; j < polylines[i].getLatLngs()[0].length; j++){
									var lat = polylines[i].getLatLngs()[0][j].lat;// - (m == zuNum ? 0.00033 : 0);
									var lng = polylines[i].getLatLngs()[0][j].lng;
									points.push([lat, lng]);
								
								}
								var center = getCenterFromPoints(points);
								arendatorMarkers[m].setLatLng(center);
								arendatorMarkers[m].setOpacity(1);
							}
						}
					}
					pDopData.innerHTML = "";

					var fields = ["Арендаторы", "Договоры аренды", "Занимаемая площадь", "Здания и сооружения", "Земельные участки", "Стоимость аренды", "Файлы", "Деятельность", "Количество рабоников"]; 
					var ar = objectlink.gOrm("gT2", [
						["Арендаторы", "Договоры аренды", "Участок аренды", "Занимаемая площадь", "Здания и сооружения", "Земельные участки", "Стоимость аренды", "Файлы", "Деятельность", "Количество рабоников"],
						[[2,1],[3,2],[4,2],[5,2],[6,1]],[],false,
						decorateArr(fields, "`").concat(["`id_Договоры аренды`", "`id_Файлы`"]),
						" and `id_Арендаторы` = "+this.oid+" order by "+decorateArr(fields, "`id_", "`").join(",")
						]);
					var tb = pDopData.appendChild(cDom("TABLE"));
					var div = cDom("DIV");

					var fill = function(cont, caption, value, _oid){
						if (value) {
							var tr = cont.appendChild(cDom("TR"));
							var td = tr.appendChild(cDom("TD"));
							td.innerHTML = caption;
							td.style.borderBottom = "1px solid #333";
							td.style.color = "#999";
							var td = tr.appendChild(cDom("TD"));
							td.innerHTML = value;
							td.style.borderBottom = "1px solid #333";
							
							if (isEditMode && caption == "Договор") {
								var td = tr.appendChild(cDom("TD"));
								var but = td.appendChild(cDom("BUTTON"));
								but.innerHTML = "...";
								but.oid = _oid;

								but.onclick = function () {
									console.log("Договор аренды "+d2str(new Date()));
									var frmContainerMenu1 = new TForm(null,null,null,null,20,200000,true);
									var cnt = cDom("DIV");
									frmContainerMenu1.setBody(cnt);
									var tb = cnt.appendChild(cDom("TABLE"));
									var zd = objectlink.gOrm("gT2",[["Объект","Здания и сооружения"],[],[],false, null, "and `id_Объект` = "+oid]);									
									var zu = objectlink.gOrm("gT2",[["Объект","Земельные участки"],[],[],false, null, "and `id_Объект` = "+oid]);									
									zd = zu.concat(zd);
									var dogOid = this.oid;
									///прикрепленные здания к участку
									var ua = objectlink.gOrm("gAnd",[[dogOid,classes["Участок аренды"]],null,true])
									var chZdZu = [];
									for (var i=0; i < ua.length; i++){
										var chZd = objectlink.gOrm("gAnd",[[ua[i][0],classes["Здания и сооружения"]],null,true]);
										var chZu = objectlink.gOrm("gAnd",[[ua[i][0],classes["Земельные участки"]],null,true]);
										chZdZu = chZdZu.concat(chZd.concat(chZu));
									}
									///
									var tr = tb.appendChild(cDom("TR"));
									var td = tr.appendChild(cDom("TD"));
									td.innerHTML = "<h3>Связанные с договором аренды и арендодателем здания и земельные участки:</h3><br>";
									
									for (var i=0; i < zd.length; i++){
										var tr = tb.appendChild(cDom("TR"));
										var td = tr.appendChild(cDom("TD"));
										var ch = td.appendChild(cInp("checkbox"));
										var chOid = zd[i][2];
										var chId = "oid"+chOid;
										ch.id = chId;
										ch.oid = chOid;
										ch.dogOid = dogOid;

										for (var j=0; j < chZdZu.length; j++){
											if (chZdZu[j][0] == chOid) ch.checked = true;
										}

										var label = td.appendChild(cDom("LABEL"));
										label.innerHTML = zd[i][3];
										label.setAttribute("for", chId);
										ch.onchange = function(){
											var dogOid = this.dogOid;//2360;//test
											if (this.checked) {
												var val = "участок договора "+dogOid+" здания/зу "+this.oid+" "+d2str(new Date());
												ua = objectlink.gOrm("cO", [val, classes["Участок аренды"]]);
												if (ua) {
													objectlink.gOrm("cL", [ua, dogOid]);
													objectlink.gOrm("cL", [this.oid, ua]);
													console.log("создан Участок аренды: "+ua+ "; cL ("+this.oid+"," +ua+")");
												}
											} else {
												var ua = objectlink.gOrm("gAnd",[[dogOid,classes["Участок аренды"],this.oid],null,true])
												ua = ua && ua.length ? ua[0][0] : null;
												if (ua) {
													objectlink.gOrm("eL", [this.oid, ua]);
													objectlink.gOrm("eO", [ua, null]);
													console.log("удален Участок аренды: "+ua+ "; eL ("+this.oid+"," +ua+")");
												}
											}
										}
									}
								}
								td.style.borderBottom = "1px solid #333";
							}
						}
					}
					
					fill(tb, "Арендатор", ar[0][0]);
					var dog_ = null;
					var square_ = null;
					var files = [];
					var ind = 0;
					for (var i=0; i < ar.length; i++){
						var dog = ar[i][1];
						var dogOid = ar[i][9];
						if (dog_ != dog) {
							$(tb).append("<tr style='height:10px'><td colspan=2></td></tr>");
							fill(tb, "Договор", dog, dogOid);
							
						}
						dog_ = dog;
						
						var square = ar[i][2];
						if (square_ != square){
							$(tb).append("<tr><td colspan=2 style='border-bottom:1px solid #999'></td></tr>");
							var zd = ar[i][3];
							var zu = ar[i][4];
							var sale = ar[i][5];
							var doing = ar[i][7];
							var workers = ar[i][8];
							fill(tb, "Занимаемая площадь", square+" м2");
							fill(tb, "Место аренды", zd || zu);
							fill(tb, "Стоимость аренды", sale+" руб/мес");
							fill(tb, "Деятельность", doing);
							fill(tb, "Количество рабоников", workers);
						}
						square_ = square;
						
						var file = ar[i][6];
						var fileOid = ar[i][10];
						if (files && !~files.indexOf(file)){
							$(div).append("<input class='chFileButtonHtml' type='checkbox' id='oid"+fileOid+"' value='"+domain+url2cp1251(file)+"' hidden/>");
							$(div).append(getFileButtonHtml(file));
							files.push(file);
						}
					}

					var tr = tb.appendChild(cDom("TR"));
					var td = tr.appendChild(cDom("TD"));
					td.setAttribute("colspan", 2);
					td.appendChild(div);

					var tr = tb.appendChild(cDom("TR"));
					var td = tr.appendChild(cDom("TD"));
					td.setAttribute("colspan", 2);
					td.innerHTML = "Счета:";

					var fields = ["Счет","Счет продукт","Счет количество","Счет стоимость","Счет месяц","Счет год","Арендаторы","Объект"];
					var orders = objectlink.gOrm("gT2", [fields,[],[],false,["`id_Счет`","`Счет продукт`","`Счет месяц`","Арендаторы"],
						" and `id_Объект`="+oid+" and `id_Арендаторы` = "+this.oid+" order by `id_Счет месяц` desc, `id_Счет продукт`"
					]);
					var tr = tb.appendChild(cDom("TR"));
					var td1 = tr.appendChild(cDom("TD"));
					td1.style.width = "50%";
					var td2 = tr.appendChild(cDom("TD"));
					td2.valign = "top";
					var orderclick = function(){
						var fields = ["Счет","Счет продукт","Счет количество","Счет стоимость","Счет месяц","Счет год"];
						td2.innerHTML = "";
						fillCardEasy(fields, this.oid, td2);
					}
					
					for (var i=0; i < orders.length; i++){
						var but = td1.appendChild(cDom("BUTTON"));
						td1.appendChild(cDom("BR"));
						but.innerHTML = "счет "+orders[i][1]+" "+months[orders[i][2]-1];
						but.style.width = "100%";
						but.id = "but"+orders[i][0];
						but.oid = orders[i][0];	
						but.onclick = orderclick;

					}
					if (isEditMode) {
						createCardUploadFiles(pDopData, this.oid);
					}
				}
				
				showInf(pDopData, tb);
				
			}
			
			function getReportsInf(){
				var arr = ["Арендуемые и свободные площади", "Затраты и перевыставления за 2017 год", "Затраты и перевыставления за 2016 год"/*, "тестовый"*/];
				pDopData.innerHTML = "";
				var tb = pDopData.appendChild(cDom("TABLE"));
				tb.style.width = "100%";
				$(tb).append("<tr><td><h3>Отчеты</h3></td></tr>");
				for (var i=0; i < arr.length; i++){
					var tr = tb.appendChild(cDom("TR"));
					var td = tr.appendChild(cDom("TD"));
					var but = td.appendChild(cDom("BUTTON"));
					but.innerHTML = arr[i];
					but.id = "butReport"+i;
					but.reportId = i;
					but.onclick = funcclick;
				}
				
				function funcclick(){
					switch (this.reportId) {
						case 0:
							reportEmptyFond2();
						break
						case 1:
							reportCommunicationOrders2(2017);
						break
						case 2:
							reportCommunicationOrders2(2016);
							//reportTest();
						break
					
					}
				}
			}

			function reportCommunicationOrders2(year){
				var arr = getOrm("select f2,f3,f4,'затраты','перевыст',f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26,f27,f28,f29 "
					+"from expl_zatrat_"+year+" where f1 is not null and f1 <> '' and f1 = "+oid, "all2object").data;
				var arrH = ["Тип", "Поставщик", "Договор", "+/-", "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь", "Итого"];
				var arrF = ["Итого","","","затраты","перевыст",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
				arr.splice(0,0,arrH);
				arr.push(arrF);
				var div = cDom("DIV");
				var lab = div.appendChild(cDom("H3"));
				lab.innerHTML = "Отчет по затратам и перевыставлениям за 2016 год";
				var tb = div.appendChild(cDom("TABLE"));
				for (var i=0; i < arr.length; i++){
					if (!arr[i] || !arr[i].length) return ret;
					var tr = tb.appendChild(cDom("TR"));
					var ind = 0;
					var zat_sum = 0;
					var per_sum = 0;
					for (var j=0; j < arrH.length; j++){
						var td = tr.appendChild(cDom("TD"));
						td.style.width = "5%";
						td.style.fontSize = "11px";
						
						if (i == 0) {
							td.style.fontWeight = "bold";
							td.innerHTML = arrH[j];
						} else {
							if (j < 3) {
								td.innerHTML = arr[i][j] || "";
							} else if (j === arrH.length-1) {
								td.innerHTML = zat_sum.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"<HR style='border:0; height:0; border-top:1px solid #fff'>"+per_sum.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ');
							} else {
								var zat = arr[i][3+ind*2] || "0.00";
								var per = arr[i][4+ind*2] || "0.00";

								td.innerHTML = zat+"<BR>"+per;
								if (j > 3) {
									td.innerHTML = parseFloat(zat).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"<HR style='border:0; height:0; border-top:1px solid #999'>"+parseFloat(per).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ');
									zat_sum += parseFloat(zat);
									per_sum += parseFloat(per);
									
									if (i < arr.length-1) {
										td.style.color = "#999";
									}
									//td.style.fontSize = "11px";
									//td.style.width = "7%";
									arr[arr.length-1][3+ind*2] += parseFloat(zat);
									arr[arr.length-1][4+ind*2] += parseFloat(per);
								}
								ind++;
							}
						}
						td.style.border = "1px solid #999";
					}
				}
				//showModalHtml(div, true);
				var frmContainerMenu1 = new TForm(null,null,null,null,20,200000,true);
				frmContainerMenu1.setBody(div);

			}

			function reportEmptyFond2(){
				var arr = getOrm("select f4,f5,f6,f7,f9,f10,f11,f12,f8 from expl_arenda_square where f1 is not null and f1 <> '' and f1 = "+oid, "all2object").data;
				var arrH = ["Тип", "Общая площадь, м2", "Пригодная площадь, м2", "Непригодная площадь, м2","Площадь в аренде, м2","Площадь в аренде, %","Свободные площади, м2","Свободные площади, %","Примечание"];
				arr.splice(0,0,arrH);
				var div = cDom("DIV");
				var lab = div.appendChild(cDom("H3"));
				lab.innerHTML = "Отчет по занятым и свободным площадям на 01.02.2017";
				var tb = div.appendChild(cDom("TABLE"));
				for (var i=0; i < arr.length; i++){
					if (!arr[i] || !arr[i].length) return ret;
					var tr = tb.appendChild(cDom("TR"));
					for (var j=0; j < arr[i].length; j++){
						var td = tr.appendChild(cDom("TD"));
						td.innerHTML = arr[i][j];
						if (i==0) td.style.fontWeight = "bold";
						td.style.width = "10%";
						td.style.border = "1px solid #999";
					}
				}
				showModalHtml(div, true);
			}
			
			function reportEmptyFond(){
				var sale = ["700", "500", "350"];
				var fields = ["", "Здания и сооружения", "Полезная площадь", "Занимаемая площадь", "Свободная площадь", "Цена за м2", "Потенциальная прибыль"]; 
				var arr = objectlink.gOrm("gT2", [
					["Объект", "Фонд Аренды", "Здания и сооружения", "Технические данные", "Полезная площадь", "Участок аренды", "Занимаемая площадь"],
					[[2,1],[3,2],[4,3],[5,2],[6,5]],[],false,
					//decorateArr(fields, "`"),
					["`id_Объект`","`Здания и сооружения`", "`Полезная площадь`", 
					"ifnull(sum(`Занимаемая площадь`),0)", 
					"ifnull(`Полезная площадь`-sum(`Занимаемая площадь`),`Полезная площадь`)", 
					"case when `Здания и сооружения` like '%здани%' or `Здания и сооружения` like '%бытов%' then "+sale[0]+" else "+sale[1]+" end", 
					"ifnull(`Полезная площадь`-sum(`Занимаемая площадь`),`Полезная площадь`) * case when `Здания и сооружения` like '%здани%' or `Здания и сооружения` like '%бытов%' then 700 else 500 end" 
					],
					" and `id_Объект` = "+oid+" group by `Здания и сооружения` order by `id_Здания и сооружения`"
					]);
				//pDopData.innerHTML = "";
				var tb = getOrmObject({columns:fields, data:arr}, "all2domtable");
				$.each($(tb).find("tr").find("td:first-child"), function(ind, value){
					value.style.color = "#000";
				})
				$.each($(tb).find("tr").find("td"), function(ind, value){
					value.style.borderBottom = "1px solid #333";
				})
				//$(pDopData).append(tb);
				showModalHtml(tb, true);
				tb.setAttribute("align", "left");
				showModalHtml("<table><tr style='height:20px'><td></td></tr></table>");
				
				var fields = ["", "Итого", "Полезная площадь", "Занимаемая площадь", "Свободная площадь", "Цена за м2", "Потенциальная прибыль"]; 
				var arr = objectlink.gOrm("gT2", [
					["Объект", "Фонд Аренды", "Здания и сооружения", "Технические данные", "Полезная площадь", "Участок аренды", "Занимаемая площадь"],
					[[2,1],[3,2],[4,3],[5,2],[6,5]],[],false,
					//decorateArr(fields, "`"),
					[" `id_Объект`,`Здания и сооружения`, sum(`Полезная площадь`), sum(busy), sum(`Полезная площадь`) - sum(busy), '000', sum(sale) from (select "+
					"`id_Объект`","`Здания и сооружения`", "`Полезная площадь`", 
					"ifnull(sum(`Занимаемая площадь`),0) busy", 
					"ifnull(`Полезная площадь`-sum(`Занимаемая площадь`),`Полезная площадь`)", 
					"case when `Здания и сооружения` like '%здани%' or `Здания и сооружения` like '%бытов%' then "+sale[0]+" else "+sale[1]+" end", 
					"ifnull(`Полезная площадь`-sum(`Занимаемая площадь`),`Полезная площадь`) * case when `Здания и сооружения` like '%здани%' or `Здания и сооружения` like '%бытов%' then 700 else 500 end sale" 
					],
					" and `id_Объект` = "+oid+" group by `Здания и сооружения` order by `id_Здания и сооружения`"
					+")x group by `id_Объект`"
					]);
				var tb = getOrmObject({columns:fields, data:arr}, "all2domtable");
				$.each($(tb).find("tr:last-child").find("td"), function(ind, value){
					value.style.color = ind < 2 || ind==5 ? "#000" : 
					value.style.color = ind == 2 ? "#999" : 
					value.style.color = ind == 3 ? "#00ff00" : 
					value.style.color = ind == 6 ? "ff0000" : 
					"#fff";
				})
				//$(pDopData).append(tb);
				showModalHtml(tb);
				tb.setAttribute("align", "left");
				showModalHtml("<table><tr style='height:20px'><td></td></tr></table>");

				var but = cDom("BUTTON");
				var img = but.appendChild(cDom("IMG"));
				img.src = "images/excel.png";
				img.width = "32";
				but.onclick = function(){
					export2Excel($("#modalBody").get(0))
				}
				but.title = "Эспорт таблицы в Excel";
				showModalHtml("<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				showModalHtml(but);
				
				showModalHtml("<table width='100%'><tr><td align='left'><div id='graph'>Loading graph...</div></td></tr></table>");
				var myData = new Array([Math.round(parseFloat(arr[0][3])/parseFloat(arr[0][2])*100)+"%", parseFloat(arr[0][3])], 
				[100-Math.round(parseFloat(arr[0][3])/parseFloat(arr[0][2])*100)+"%", parseFloat(arr[0][4])]);
				var colors = ['#00ff00', '#eee'];
				var myChart = new JSChart('graph', 'pie');
				myChart.setDataArray(myData);
				myChart.colorizePie(colors);
				myChart.setTitleColor('#857D7D');
				myChart.setPieUnitsColor('#9B9B9B');
				myChart.setPieValuesColor('#6A0000');
				myChart.draw();
				
			}

			function reportCommunicationOrders(){//multithread query and fill array whith locks
				var lock = false;
				var count = 0;
				var vals = [];
				var div = cDom("DIV");

				div.innerHTML = "ОТЧЕТ ГОТОВИТЬСЯ. ОЖИДАЙТЕ ЗАВЕРШЕНИЯ...";
				showModalHtml(div, true);

				var products = ["электроэнергия", "мусор", "тепло", "интернет", "услуга техобслуживание оборудования КИПа", "Итого"];
				var productsCount = products.length-1;
				var monthCount = 5;
				var mon = months.slice(0, monthCount).concat("Итого");
				var rowCount = 3;

				for (var i=0; i < productsCount+1; i++){//fill empty vals
					vals[i] = [];
					for (var j=0; j < monthCount+1; j++){
						vals[i][j] = [0,0,0];
					}
				}
				var stopCount = productsCount * 5 * 2;

				var dt = new Date();
				for (var i=0; i < productsCount; i++){//call async ajax functions
					for (var j=0; j < monthCount; j++){
						for (var k=0; k < rowCount-1; k++){
							getSum(oid, j, 2016, i, products, k, stopCount, stopFunc);
						}
					}
				}

				function getSum(obj, month, year, product, products, isArendator, stopCount, stopFunc){//async ajax function
					objectlink.gOrmA("gT2", [
						["Счет","Счет продукт","Счет количество","Счет стоимость","Счет месяц","Счет год","Арендаторы","Объект"],
						[],[],false,
						["sum(`Счет стоимость`)"],
						" and `id_Объект`="+obj+" and `Счет год`="+year+" and `Счет месяц`="+(month+1)+" and `Счет продукт`='"+products[product]+"' and `id_Арендаторы` is "+(isArendator ? "not" : "")+" null group by `id_Объект` "
					], function(data){
						var val = data && data.length ? data[0][0] : 0;
						dispatcher(val, [product, month, isArendator], stopCount, stopFunc);//call disp function
					});
				}
				
				function dispatcher(val, params, stopCount, stopFunc){//disp function for reduce results
					while (true){
						if (!lock) {
							lock = true;
							try {
								var p0 = params[0] || 0;
								var p1 = params[1] || 0;
								var p2 = params[2] || 0;
								vals[p0][p1][p2] = parseFloat(val).toFixed(2);
							} catch (e) {
								console.log(params);
								console.log(e);
								lock = false;
							} finally {
								count++;
								lock = false;
								if (count >= stopCount) {
									stopFunc();//call stop function
								}
								return;
							}
						}
					}
				}
				
				function stopFunc(){//stop function after finish all ajax async functions
					count = 0;
					lock = false;
					
					for (var i=0; i < productsCount; i++){//summary by month-product
						for (var j=0; j < monthCount; j++){
							vals[i][j][rowCount-1] = parseFloat(vals[i][j][0] - vals[i][j][1]).toFixed(2);
						}
					}
					for (var i=0; i < productsCount; i++){//summary by year
						for (var k=0; k < rowCount; k++){
							var sum = [];
							for (var j=0; j < monthCount; j++){
								sum.push(vals[i][j][k]);
							}
							vals[i][monthCount][k] = sum.reduce(reducesum, 0);
						}
					}
					for (var j=0; j < monthCount+1; j++){//summary by all
						for (var k=0; k < rowCount; k++){
							var sum = [];
							for (var i=0; i < productsCount+1; i++){
								sum.push(vals[i][j][k]);
							}
							vals[productsCount][j][k] = sum.reduce(reducesum, 0);
							
						}
					}
					///draw table with vals result
					var div = cDom("DIV");
					showModalHtml(div, true);
					var tb = div.appendChild(cDom("TABLE"));
					tb.style.width = "100%";
					var tr = div.appendChild(cDom("TR"));
					var td1 = div.appendChild(cDom("TD"));
					var td2 = div.appendChild(cDom("TD"));
					
					for (var i=0; i < productsCount+1; i++){
						td1.appendChild(cDom("BR"));
						var cap = td1.appendChild(cDom("LABEL"));
						cap.innerHTML = products[i];
						var tb = td1.appendChild(cDom("TABLE"));
						for (var k=-1; k < rowCount; k++){
							var tr = tb.appendChild(cDom("TR"));
							for (var j=0; j < monthCount+1; j++){
								var td = tr.appendChild(cDom("TD"));
								td.style.width = "100px";
								td.innerHTML = k == -1 ? mon[j] : vals[i][j][k];
								td.style.color = k == 1 ? "#9999ff" : k == 2 ? "#ff0000" : "#fff";
								
							}
						}
					}

					///draw chart
					td2.setAttribute("align", "center");
					td2.setAttribute("valign", "middle");
					$(td2).append("<table border=1><tr><td style='color:#fff'>Счета ГУОВ</td></tr><tr><td style='color:#9999ff'>Перевыставление</td></tr><tr><td style='color:#ff0000'>Убыток</td></tr></table>");
					
					var guov = vals[productsCount][monthCount][0];
					var arend = vals[productsCount][monthCount][1];
					var sum = vals[productsCount][monthCount][2];
					
					$(td2).append("<table width='100%'><tr><td align='center'><label>Итоги за год<label><div id='graph'>Loading graph...</div></td></tr></table>");
					var myData = new Array([Math.round(parseFloat(arend)/parseFloat(guov)*100)+"%", parseFloat(arend)], 
					[100-Math.round(parseFloat(sum)/parseFloat(guov)*100)+"%", parseFloat(sum)]);
					var colors = ['#9999ff', '#ff0000'];
					var myChart = new JSChart('graph', 'pie');
					myChart.setDataArray(myData);
					myChart.colorizePie(colors);
					myChart.setTitleColor('#857D7D');
					myChart.setPieUnitsColor('#9B9B9B');
					myChart.setPieValuesColor('#6A0000');
					myChart.draw();
					//console.log(new Date() - dt);
					//console.log(vals);
					
				}
				
				function reducesum(s, cur){return (parseFloat(s) + parseFloat(cur)).toFixed(2)};//resuce summary function
				
			}
			
			function redraw_recursive_test(){
				var vals = [];

				function redraw_recursive(p1, p2, p3){
					if (p1 == 6) {
						p1 = 1;
						p2++;
						showModalHtml("");

						if (p2 == p3.length) {
							last();
							return;
						}
					}
					setTimeout(redraw_recursive, 0, p1+1, p2, p3);
				}
				
				showModalHtml("", true);
				vals.push([[],[],[]]);
				redraw_recursive(1, 0, []);

				function last(){
				}
				
			}

			function reportTest(){
				
			}
			
			function getOtherDog(){
				pDopData.innerHTML = "Ожидайте! Идет загрузка данных...";
				objectlink.gOrmA("gAnd",[[1,classes["Договоры"]]], function(data){
					pDopData.innerHTML = "";
					for (var i=0; i < data.length; i++) {
						var dogClassId = data[i][0];
						var dogClassName = data[i][1];
						if (["Организации","Документы","Арендаторы","Коммуникации на объекте"].indexOf(dogClassName) == -1) {
							var arr = objectlink.gOrm("gAnd",[[classes[dogClassName],oid]]);
							if (arr && arr.length)
								fillCard2([dogClassName, "Договоры", "Файлы", "Объект"], oid, pDopData);
						}
					}
				});
			}
		}
										
////////////////marker add to map
		function markerAddToMap(map, latlng, iconUrl, iconSize){
			iconUrl = iconUrl || "images/marker00.png";
			iconSize = iconSize || "32";
			var icon = L.icon({
				"iconUrl":iconUrl, 
				"iconSize":[iconSize,iconSize], 
				"iconAnchor":[Math.round(iconSize/2), Math.round(iconSize/2)]});
			return L.marker(
				latlng, 
				{"icon":icon}
			).addTo(map);
		}
						
////////////////search objects or addres
		var addressMarker = L.marker([0, 0]);
		addressMarker = markerAddToMap(map, [0, 0], "images/marker21.png", 32);
		var eSearch = document.getElementById('addressSearch');
		eSearch.onkeydown = function(e){
			if (e.which == 13) {
				if (this.value == "") {
					loadMainListOfObjects();
					return;
				}
				
				pObject.style.display = "table";
				pObjects.style.display = "none";
				var objects = objectlink.gOrm("gT2",[["Объект","Адрес","Здания и сооружения","ИК","Ответственный","ТУ","Широта","Долгота"],[[3,0],[4,3],[5,3]]/*,[3,5]*/,[],false,["distinct `id_Объект`", "`Объект`", "`Широта`", "`Долгота`"],
				"and (`Объект` like '%"+this.value+"%' or `Адрес` like '%"+this.value+"%' or `Здания и сооружения` like '%"+this.value+"%' or `ТУ` like '%"+this.value+"%' or `ИК` like '%"+this.value+"%' or `Ответственный` like '%"+this.value+"%')"]);
				if (objects.length) {
					pObject.innerHTML = "";

					fclick = function(){
						location.href = mainHtmlPage+"#oid="+this.oid;
						//hashchange(mapObjects);

						
					}
					loadPanel(objects, pObject, 0, 1, fclick);							
				} else {
					var coord = searchAddress(this.value);
					addressMarker.setOpacity(0);
					if (coord) {
						addressMarker.setLatLng([coord[1], coord[0]]);
						addressMarker.setOpacity(1);
						map.setView([coord[1], coord[0]],18);
					}
				}
			}
		}
		
	})

function loadMainListOfObjects(){
	pObjects.innerHTML = "";
	var buttons = [];
	var arrTu = [[1252,"УЭИ"],[1253,"СЗТП"],[1254,"СиДВ"]];
	for (var i=0; i < arrTu.length; i++){
		if (i>0) pObjects.appendChild(cDom("BR"));
		var div = pObjects.appendChild(cDom("DIV",arrTu[i][1]));
		div.style.textAlign = "center";
		div.style.fontWeight = "bold";
		var arrIk = objectlink.gOrm("gAnd",[[arrTu[i][0],classes["ИК"]]]);
		for (var j=0; j < arrIk.length; j++){
			if (arrIk[j][1] == "ТУ") continue;
			var div = pObjects.appendChild(cDom("DIV",arrIk[j][1]));
			div.style.textAlign = "center";
			div.style.fontWeight = "bold";
			var objects = objectlink.gOrm("gAnd",[[arrIk[j][0],classes["Объект"]]]);
			
			for (var k=0; k < objects.length; k++) {
				if (objects[k][1] == "ИК") objects.splice(k,1);
			}
			
			if (objects.length) {
				fclick = function(){
					location.href = mainHtmlPage+"#oid="+this.oid;
				}
				var arr = loadPanel(objects, pObjects, 0, 1, fclick);
				buttons = buttons.concat(arr);
			}
		}
	}
	pObjects.buttons = buttons;
	pObjects.style.display = "table";
	pObject.style.display = "none";
}
	
function loadAndPaintAllPolygons(map){
	var polylines = []
//console.time();
	var zu = objectlink.gOrm("gT2",[["Объект", "Земельные участки", "Полигоны на карте", "Координаты на карте"],[[2,1],[3,2]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Земельные участки`", "`id_Объект`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
	var zd = objectlink.gOrm("gT2",[["Объект", "Здания и сооружения", "Полигоны на карте", "Координаты на карте"],[[2,1],[3,2]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Здания и сооружения`", "`id_Объект`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
//console.timeEnd();
	var paintZu = mapPaint(zu, L.polygon, {color:"#00ff00", fillOpacity:0.1, weight:3}, map, classes["Земельные участки"]);
	var paintZd = mapPaint(zd, L.polygon, {color:"#00ff00", fillOpacity:0.1, weight:2}, map, classes["Здания и сооружения"]);
	polylines = paintZu ? polylines.concat(paintZu) : polylines;
	polylines = paintZd ? polylines.concat(paintZd) : polylines;
	
	var buttons = pObjects.buttons;
	for (var i=0; i < buttons.length; i++) {
		var but = buttons[i];
		but.poly = [];
		for (var j=0; j < polylines.length; j++) {
			var poly = polylines[j];
			if (but.oid == poly.objid) {
				but.poly.push(poly);
				poly.but = but;

				poly.on('mouseover', function(e) {
					this.setStyle({color : "#ff5555"});
					this.but.style.backgroundColor = "rgba(0,255,0,0.3)";
					var dom = gDom("but"+this.oid);
					if (dom) dom.onmouseover();
				})
				poly.on('mouseout', function(e) {
					this.setStyle({color : "#00ff00"});
					this.but.style.backgroundColor = "rgba(0,0,0,0.3)";
					var dom = gDom("but"+this.oid);
					if (dom) dom.onmouseout();
				})
				poly.on('click', function(e) {
					this.but.onclick();
					var dom = gDom("but"+this.oid);
					if (dom) dom.onclick();
				})
			}
		}
		but.onmouseover = function(){
			var poly = this.poly;
			for (var i=0; i < poly.length; i++) {
				var p = poly[i];
				p.setStyle({color : "#ff5555"});
			}
		}
		but.onmouseout = function(){
			var poly = this.poly;
			for (var i=0; i < poly.length; i++) {
				var p = poly[i];
				p.setStyle({color : "#00ff00"});
			}
		}
	}
	return polylines;
}
	
function TForm (parentDom, width, height, left, top, zIndex, visible){
	var that = this;
	var dom = cDom("DIV");
	parentDom = parentDom || document.body;
	if (parentDom) parentDom.appendChild(dom);
	dom.style.display = visible ? "block" : "none";
	dom.style.position = "fixed";
	dom.style.zIndex = zIndex || 100;
	dom.style.left = 0;
	dom.style.top = 0;
	dom.style.width = "100%";
	dom.style.height = "100%";
	dom.style.overflow = "hidden";
	dom.style.backgroundColor = "rgba(0,0,0,0.8)";
	dom.style.overflowY = "scroll";

	var body = dom.appendChild(cDom("DIV"));
	body.innerHTML = "<br><br>";
	body.style.position = "relative";
	body.style.backgroundColor = "#000";
	body.style.margin = "auto";
	body.style.padding = "5px 5px 5px 5px";
	body.style.left = left || 0;
	body.style.top = top || 0;
	body.style.width = width || "90%";
	body.style.height = height || body.style.height;
	body.style.boxShadow = "0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)";
	
	var head = cDom("DIV");
	head.style.color = "#fff";
	head.style.float = "right";
	head.style.fontSize = "28px";
	head.style.fontWeight = "bold";
	head.style.cursor = "pointer";
	head.style.padding = "0px 5px";
	
	var span = head.appendChild(cDom("SPAN"));
	span.innerHTML = "&times";
	span.onclick = function() {	that.setVisible(false);	}
	
	this.setBody = function(val) {
		$(body).html("");
		$(body).append(head);
		$(body).append("<BR><BR>");
		$(body).append(val);
	}
	
	this.setVisible = function(val) { dom.style.display = val ? "block" : "none"; }
	this.getDom = function() { return dom; }
	this.getBody = function() { return body; }
	this.setWidth = function(val) {	body.style.width = val; }
	this.setHeight = function(val) { body.style.height = val; }
	this.setTop = function(val) { body.style.top = val; }
	this.setLeft = function(val) { body.style.left = val; }
	this.setZIndex = function(val) { dom.style.zIndex = val; }
	
}	

function testindex(){
	var frmProgress = new TForm(null,null,null,null,20,250000,true);
	var progressBarDiv = cDom("DIV");
	frmProgress.setBody(progressBarDiv);
	var progressBar = progressBarDiv.appendChild(cDom("progress"));
	var data = objectlink.gOrm("gT2", [["Объект","Здания и сооружения","Правоустанавливающие документы","Файлы","Полигоны на карте","Координаты на карте"],[[2,1],[3,1],[4,1],[5,4]]], progressBar);
	console.log(data);
/*
	var arr = getOrm("select * from ttt_dog_zatrat where f1 is not null and f1 <> ''", "rows2object");
	
	for (var i=0; i < arr.length; i++) {//contracts
		var oid = arr[i].f1;
		if (!oid) continue;
		var type = arr[i].f2;
		var dog = arr[i].f3+" "+arr[i].f4;
		var dogAgent = arr[i].f3;
		var dogNum = arr[i].f4;
		var dogDate = arr[i].f5;
		
		switch (type) {
			case "Водоснабжение": type = "ХВС";
			break;
			case "Водоотведение": type = "Канализация";
			break;
			case "Теплоснабжение": type = "Отопление";
			break;
			case "Вывоз ТБО": type = "Вывоз КГМ и ТБО";
			break;
		}
		
		console.log(arr.length + "/" + i+1);
		//if (i<9) {
			var commClassOid = classes[type];
			if (!commClassOid) {//если нет типа договора - создать
				commClassOid = objectlink.gOrm("cO", [type, classes["Класс"]]);
				objectlink.gOrm("cL", [classes["Договоры"], commClassOid]);
				//console.log("cO ("+type+" "+classes["Класс"]+") = "+commClassOid);
			}
			
			var commOid = objectlink.gOrm("gAnd", [[commClassOid,oid]]);
			if (!commOid || !commOid.length) {//если нет типа договора в объекте - создать
				commOid = objectlink.gOrm("cO", [type+" "+oid, commClassOid]);
				objectlink.gOrm("cL", [commOid, oid]);
				//console.log("cO ("+type+" "+oid+","+commClassOid+") = "+commOid);
				//console.log("cL ("+commOid+","+oid+")");
			} else {
				commOid = commOid[0][0];
				//console.log("gAnd ("+commClassOid+","+oid+") = "+commOid);
			}
			
			if (commOid) {
				var dogOid = objectlink.gOrm("gAnd", [[commOid, classes["Договоры"]]]);
				if (!dogOid || !dogOid.length) {
					dogOid = objectlink.gOrm("cO", [dog, classes["Договоры"]]);
					if (dogOid) objectlink.gOrm("cL", [dogOid, commOid]);
				} else {
					dogOid = dogOid[0][0];
				}
			};

	}*/
	return "finish";
}

</script>
	</head>
	<body>
		<div id="myModal" class="modal">
		  <div class="modal-content">
			<div class="modal-header">
			  <span class="close">&times;</span>
			  <h3 id='modalTitle'></h3>
			</div>
			<div class="modal-body" id='modalBody'>
			</div>
			<div class="modal-footer" id='modalFooter'>
			</div>
		  </div>
		</div>
		
		<table id="mainTable">
		<tr>
			<td align="center" valign="middle">
				<div id="map" width="100%" height="100%"></div>
			</td>
		</tr>
		</table>
		
		<div id='logo' style='position:absolute; left:1000px; top:10px; width:100px; z-index:100000; background-color:rgba(0,0,0,0.5); text-align:center; border-radius:5px'>
			<img src='images/logo.png' width='64'/><br>
			<label>База Данных Управления Эксплуатации Имущества</label>
		</div>
		
		<div id='pSearch' style='position:absolute; left:10px; top:100px; width:350px; background-color:rgba(0,0,0,0.5); z-index:100000' class='div-table'>
			<input type="text" id="addressSearch" placeholder="Поиск объектов или адреса" style="width:100%; color:#fff; border: 1px solid #999" class='alpha' />
		</div>
		<div id='pMain' style='position:absolute; height:600px; width:350px; left:10px; top:140px; background-color:rgba(0,0,0,0.5); z-index:100000; overflow-y:auto; overflow-x:hidden' hidden>
			<div id='pObjects' style='background-color:rgba(0,0,0,0); border:0px; width:100%' class='div-table'>
			</div>
			<div id='pObject' style='background-color:rgba(0,0,0,0); border:0px; width:100%' class='div-table'>
			</div>
		</div>
		<div id='pDop' hidden style='position:absolute; height:300px; width:500px; left:1030px; top:540px; background-color:rgba(0,0,0,0.8); z-index:100000; overflow-y:auto; overflow-x:hidden'>
			<div style="text-align:right;width:100%; cursor:pointer" onmousedown="gDom('pDop').hidden=true">Х</div>
			<div id='pDopData' style='background-color:rgba(0,0,0,0); border:0px; width:100%' class='div-table'>
			</div>
		</div>
		<div style='position:absolute' hidden>
			<table id='setup'>
			<tr><td colspan=2><h3>Настройки</h3></td></tr>
			<tr><td>Ширина информационного окна</td><td><input type='edit' id='eDopWidth' /></td></tr>
			<tr><td>Высота информационного окна</td><td><input type='edit' id='eDopHeight'/></td></tr>
			<tr><td>Режим рисования полигонов</td><td><input type='checkbox' id='chPaintMode'/></td></tr>
			<tr><td>Режим редактирования</td><td><input type='checkbox' id='chEditMode' /></td></tr>
			</table>
		</div>
		<div style='position:absolute; left:0px; top:0px; width:100%; height:100%; z-index:1100000; background-color:rgba(0,0,0,0.9)' id='mainContainer'>
			<div id='pLogin' style='position:fixed; left:500px; top:400px; background-color:rgba(0,0,0,0.5)'>
				<form name="fLogin" onsubmit='return false;' id='fLogin'>
				<table cellpadding="5" cellspacing="5">
					<tr><td>Логин:</td><td> <input type='text' id='eUser' autofocus></td></tr>
					<tr><td>Пароль:</td><td> <input type='password' id='ePassword' name='ePassword'></td></tr>
					<tr><td colspan=2 align='center'><button id='bLogin'>Войти</button></td></tr>
				</table>
				</form>
			</div>
		</div>
		
	</body>
</html>