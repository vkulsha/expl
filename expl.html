<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		
		<link rel="stylesheet" href="css/leaflet.css" />
		<link rel="stylesheet" type="text/css" href="css/main.css">

		<script src="js/jquery-2.2.0.min.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/leaflet.js"></script>		
		<script src="js/uService.js"></script>
		<script src="js/Main.js"></script>
		<script src="js/objectlink.js"></script></head>

<script>
////////////policy
	var classes_ = objectlink.gOrm("gAnd",[[1],"n,id"]);
	var classes = hash4arr(classes_);
/*
	var key = $_GET("key");
	var userKey = key || objectlink.getObjectFromClass("Ключи доступа пользователей", "undefined") || 0;
	var userId = objectlink.gAND([userKey, classes["Пользователи"]]);
	if (userId.length){
		userId = userId[0];
		var mainInterface = getMainInterfaceKey(userId);
		var curInterface = $_GET(interfaceUrlKey);
		
		if (curInterface && key){
		} else {
			curInterface = mainInterface;
		}
		if (curInterface) {
			$(document).ready(function() {
				var policy = showInterfaceElements(userId, curInterface);
				var mainContainer = gDom("mainContainer");
				if (!mainContainer.hidden) {
					//getHttp(curInterface+".htm", function(data){ $(mainContainer).append(data); }, true);
				}
			});
		}
	}
*/			
			
////////////documentReady
	$(document).ready(function(){
		//var objectId = $_GET(objectIdUrlKey);
		var pSearch = gDom("pSearch");
		var pMain =  gDom("pMain");
		pMain.style.height = windowHeight()-170+"px";
		var pObjects = gDom("pObjects");
////////////////modal
		var modal = document.getElementById('myModal');
		var span = document.getElementsByClassName("close")[0];

		span.onclick = function() {
			modal.style.display = "none";
		}

		window.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}
		
		window.onkeydown = function(event) {
			if (event.keyCode == 27) {
				modal.style.display = "none";
			}
		};

////////////////showModal
		function showModal(uri, _oid, mainoid){
			gDom("modalTitle").innerHTML = "";
			gDom("modalBody").innerHTML = "";
			gDom("modalFooter").innerHTML = "";
			
			if (_oid) location.href = mainHtmlPage+"#oid="+mainoid+"&"+objectIdUrlKey+"="+_oid;
			//getHttp(uri, function(data){ $("#modalBody").append(data); }, true);
			modal.style.display = "block";
			loadXML(uri, true, true, false, function(data){
				$("#modalBody").append(data);
			});
		
		}
		
////////////////map init
		var map = L.map('map');
		var mapObjects = initMap(map);
		
		window.onhashchange = function(){
			hashchange(mapObjects);
		}

		hashchange(mapObjects);
		
		function hashchange(mapObjects){
			var oid = $_GET("oid", "#", location.hash) || "115";
			var ind = mapObjects.objects.oid.indexOf(oid);
			if (~ind) map.setView([mapObjects.objects.lat[ind], mapObjects.objects.lon[ind]], 18);
			
			pObjects.innerHTML = "";
			var zd = objectlink.gOrm("gT",[["Объект","Здания и сооружения","Адрес","ИК","Ответственный","ТУ"],[[3,0],[4,3],[5,3]],[3,5],[],false,null, "and `id Объект` = "+oid+" order by `id Здания и сооружения`"]);
			
			$(pObjects).append("Объект: <label style='color:#00ff00'>"+zd[0][1]+"</label><br>");
			$(pObjects).append("Адрес: <label style='color:#00ff00'>"+zd[0][5]+"</label><br>");
			$(pObjects).append("Территориальное управление: <label style='color:#00ff00'>"+zd[0][11]+"</label><br>");
			$(pObjects).append("Имущественный комплекс: <label style='color:#00ff00'>"+zd[0][7]+" ("+zd[0][9]+") </label><br>");
			$(pObjects).append("<br>Состав имущества на объекте:<br>");
			var fclick = function(){
				showModal("iCard"+getCardVersionByOid(this.oid)+".htm", this.oid, oid);
			}
			loadPanel(zd, pObjects, 2, 3, fclick);

////////////////polygons objects
			var zu = objectlink.gOrm("gT",[["Объект", "Земельные участки", "Полигоны на карте", "Координаты на карте"],[[2,1],[3,2]],[],[],false, "`Координаты на карте`, `id Полигоны на карте`, `id Земельные участки`", "and `id Объект` = "+oid+" and `id Координаты на карте` is not null order by `id Полигоны на карте`,`id Координаты на карте`"]);
			var zd = objectlink.gOrm("gT",[["Объект", "Здания и сооружения", "Полигоны на карте", "Координаты на карте"],[[2,1],[3,2]],[],[],false, "`Координаты на карте`, `id Полигоны на карте`, `id Здания и сооружения`", "and `id Объект` = "+oid+" and `id Координаты на карте` is not null order by `id Полигоны на карте`,`id Координаты на карте`"]);
			var el = objectlink.gOrm("gT",[["Электроснабжение", "Полигоны на карте", "Координаты на карте"],[[2,1]],[],[],false, "`Координаты на карте`, `id Полигоны на карте`, `id Электроснабжение`", "and `id Электроснабжение` = "+1899+" and `id Координаты на карте` is not null order by `id Полигоны на карте`,`id Координаты на карте`"]);

			var polylines = [];
			paintZu = mapPaint(zu, L.polygon, {color:"#00ff00", fillOpacity:0.1}, map);
			paintZd = mapPaint(zd, L.polygon, {color:"#00ff00", fillOpacity:0.1}, map);
			polylines = paintZu ? polylines.concat(paintZu) : polylines;
			polylines = paintZd ? polylines.concat(paintZd) : polylines;
////////////////markers electro				
			var arrEl = [];
			var elLines = mapPaint(el, L.polyline, {color:"#ff9900", weight:1}, map);
			if (elLines && elLines.length){
				var elCoord = elLines[0].getLatLngs()[0];
				var markerElectro = markerAddToMap(map, [elCoord.lat, elCoord.lng], "images/markerElectro.png")
				var elCoord = elLines[0].getLatLngs()[6];
				var elCounter1 = markerAddToMap(map, [elCoord.lat, elCoord.lng], "images/markerElectroCounter.png")
				var elCoord = elLines[10].getLatLngs()[0];
				var elCounter2 = markerAddToMap(map, [elCoord.lat+0.00015, elCoord.lng], "images/markerElectroCounter.png")
				arrEl = arrEl.concat(/*elLines, */markerElectro, elCounter1, elCounter2);
			}
			map.on("zoomend", function(){
				for (var i=0; i < arrEl.length; i++) {
					if (map.getZoom() < 17) {
						arrEl[i].setOpacity(0);
					} else {
						arrEl[i].setOpacity(1);
					}
				}
			})
////////////////events and paint photos of polylines			
			for (var i=0; i < polylines.length; i++){
				polylines[i].on('mouseover', function(e) {
					this.setStyle({color : "#ff5555"});
				});
				
				polylines[i].on('mouseout', function(e) {
					this.setStyle({color : "#00ff00"});
				});	

				polylines[i].on('click', function(e) {
					showModal("iCard"+getCardVersionByOid(this.oid)+".htm", this.oid, oid);
				});	
						
////////////////////paint photos
				if (false) {
					var points = [];
					for (var j=0; j < polylines[i].getLatLngs()[0].length; j++){
						var lat = polylines[i].getLatLngs()[0][j].lat;
						var lng = polylines[i].getLatLngs()[0][j].lng;
						points.push([lat, lng]);
					
					}
					var center = getCenterFromPoints(points);
					
					var _oid = polylines[i].oid;
					var foto = objectlink.gOrm("gT",[["Здания и сооружения", "Фото"],[],[],[],false, "`Фото`", "and `id Здания и сооружения` = "+_oid]);

					var ObjectIcon = L.Icon.extend({
						options: {
							iconSize:     [32, 32],
							iconAnchor:   [16, 16]
						}
					});
					var markers = L.layerGroup();

					function click(that){
						showModal("cardPhoto.htm", that.oid, oid);
					}
					
					if (foto.length){
						for (var j=0; j < 1; j++){
							var fn = foto[j][0];
						
							var objectIcon = new ObjectIcon({iconUrl: fn});
							var marker = L.marker(center, {icon:objectIcon})
								.addTo(markers)
							marker.oid = _oid;
							marker.fn = fn;
							marker
								.on("click", function(){
									click( this )
								});
							
						}
					}
					markers.addTo(map);
				}
						
/////////////////////////////					
			}
		}
										
////////////////marker add to map
		function markerAddToMap(map, latlng, iconUrl, iconSize){
			iconUrl = iconUrl || "images/marker00.png";
			iconSize = iconSize || "32";
			var icon = L.icon({
				"iconUrl":iconUrl, 
				"iconSize":[iconSize,iconSize], 
				"iconAnchor":[Math.round(iconSize/2), Math.round(iconSize/2)]});
			return L.marker(
				latlng, 
				{"icon":icon}
			).addTo(map);
		}
				
////////////////load to panel
		function loadPanel(arr, container, idInd, valInd, funcClick){
			for (var i=0; i < arr.length; i++){
				var row = arr[i];
				var drow = container.appendChild(cDom("DIV"));
				drow.classList.add("div-table-row");
				drow.classList.add("alpha");
				var dcol = drow.appendChild(cDom("DIV"));
				dcol.classList.add("div-table-col");
				dcol.classList.add("alpha");
				dcol.style.backgroundColor = "rgba(0,0,0,0.1)";
				var but = dcol.appendChild(cDom("BUTTON"));
				but.oid = row[idInd];
				but.row = row;
				but.innerHTML = row[valInd];
				but.style.width = "100%";
				but.classList.add("alpha");

				but.onclick = funcClick;
			}
		}

////////////////search objects or addres
		var addressMarker = L.marker([0, 0]);
		var eSearch = document.getElementById('addressSearch');
		eSearch.onkeydown = function(e){
			if (e.which == 13) {
				var objects = objectlink.gOrm("gT",[["Объект","Адрес","Здания и сооружения","ИК","Ответственный","ТУ","Широта","Долгота"],[[3,0],[4,3],[5,3]],[3,5],[],false,"distinct `id Объект`,`Объект`,`Широта`,`Долгота`",
				"and (`Адрес` like '%"+this.value+"%' or `Здания и сооружения` like '%"+this.value+"%' or `ТУ` like '%"+this.value+"%' or `ИК` like '%"+this.value+"%' or `Ответственный` like '%"+this.value+"%')"]);
				if (objects.length) {
					pObjects.innerHTML = "";

					fclick = function(){
						location.href = mainHtmlPage+"#oid="+this.oid;
						
					}
					loadPanel(objects, pObjects, 0, 1, fclick);							
				} else {
					var coord = searchAddress(this.value);
					addressMarker.setOpacity(0);
					if (coord) {
						addressMarker = markerAddToMap(map, [coord[1], coord[0]], "images/marker21.png", 32);
						map.setView([coord[1], coord[0]],18);
					}
				
				}
			}
		}

	})
</script>

	</head>
	<body>
		<div id="myModal" class="modal">
		  <div class="modal-content">
			<div class="modal-header">
			  <span class="close">&times;</span>
			  <h3 id='modalTitle'></h2>
			</div>
			<div class="modal-body" id='modalBody'>
			</div>
			<div class="modal-footer" id='modalFooter'>
			</div>
		  </div>
		</div>
		
		<table id="mainTable">
		<tr>
			<td align="center" valign="middle" id="mainContainer">
				<div id="map" width="100%" height="100%"></div>
			</td>
		</tr>
		
		<div id='pSearch' style='position:absolute; left:10px; top:100px; background-color:rgba(0,0,0,0.3); z-index:100000; width:300px' class='div-table'>
			<input type="text" id="addressSearch" autofocus placeholder="Поиск" style="width:100%; color:#fff; border: 1px solid #999" class='alpha' />
		</div>
		<div id='pMain' style='position:absolute; left:10px; top:140px; background-color:rgba(0,0,0,0.3); z-index:100000; overflow-y:auto; overflow-x:hidden; height:600px; width:300px'>
			<div id='pObjects' style='background-color:rgba(0,0,0,0); border:0px; width:100%' class='div-table'>
			</div>
		</div>
	</body>
</html>